<div class="min-h-screen bg-gray-50 py-4
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header del proyecto -->
    <div class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h1 class="text-3xl font-bold text-gray-900"><%= @project.name %></h1>
            <p class="text-gray-600 mt-1">üÜî ID: <%= @project.project_identifier %></p>
            <p class="text-gray-600">Orden de compra: <%= @project.purchase_order %></p>
            <p class="text-gray-600">Localidad: <%= @project.locality %></p>
            <% if @project.settlement_date.present? %>
              <p class="text-gray-600 mt-2">üìÖ Fecha de liquidaci√≥n: <span class="font-semibold text-green-700"><%= @project.settlement_date.strftime("%d/%m/%Y") %></span></p>
            <% end %>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-green-600">
              <%= number_to_currency(@project.quoted_value, unit: "$", separator: ",", delimiter: ".") %> COP
            </p>
            <p class="text-sm text-gray-500">Valor cotizado</p>
          </div>
        </div>
      </div>
      
      
      <!-- Estados del proyecto -->
      <div class="px-6 py-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">Estado de Pago</h3>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= @project.payment_status == 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
              <%= t("enums.project.payment_status.#{@project.payment_status}") %>
            </span>
          </div>
          <div>
            <h3 class="text-sm font-medium text-gray-700 mb-2">Estado de Ejecuci√≥n</h3>
            <div class="flex items-center gap-2">
              <%
                status_styles = {
                  'pending' => 'background-color: #f3f4f6; color: #1f2937;',
                  'running' => 'background-color: #dbeafe; color: #1e3a8a;',
                  'stop' => 'background-color: #fed7aa; color: #c2410c;',
                  'cancelled' => 'background-color: #fecaca; color: #991b1b;',
                  'ended' => 'background-color: #d1fae5; color: #065f46;',
                  'in_liquidation' => 'background-color: #f3e8ff; color: #7e22ce;'
                }
                current_style = status_styles[@project.execution_status] || 'background-color: #f3f4f6; color: #1f2937;'
              %>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium" style="<%= current_style %>">
                <%= t("enums.project.execution_status.#{@project.execution_status}") %>
              </span>
              <% if @can_edit && !@project.in_liquidation? %>
                <button type="button" onclick="toggleStatusModal()" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-blue-600 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                  </svg>
                  Actualizar
                </button>
              <% end %>
            </div>
          </div>
            <div class="flex flex-col items-start space-y-2">
              <% if @project.in_liquidation? %>
                <div class="bg-purple-100 border-2 border-purple-300 px-3 py-2 rounded-lg w-full">
                  <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="text-purple-800 text-sm font-semibold">
                      Proyecto en Liquidaci√≥n
                    </span>
                  </div>
                  <p class="text-purple-700 text-xs mb-2">
                    No se puede editar ni agregar gastos
                  </p>
                  <% if @project.settlement.present? %>
                    <%= link_to settlement_path(@project.settlement), class: "inline-flex items-center gap-1 text-xs font-medium text-purple-700 hover:text-purple-900 bg-purple-200 hover:bg-purple-300 px-2 py-1 rounded transition-colors" do %>
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      Ver Liquidaci√≥n <%= @project.settlement.period_name %>
                    <% end %>
                  <% end %>
                </div>
              <% elsif @can_edit %>
                <%= link_to "Editar Proyecto", edit_project_path(@project, from: 'show'),
                    class: "bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-center text-sm w-full" %>

                <a href="#" onclick="if(confirm('¬øEst√°s seguro de eliminar este proyecto? Esta acci√≥n no se puede deshacer.')) { document.getElementById('delete-project-<%= @project.id %>').submit(); }" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-center text-sm w-full">Eliminar Proyecto</a>
                <%= form_with url: project_path(@project), method: :delete, local: true, html: { id: "delete-project-#{@project.id}", style: "display: none;" } do |f| %><% end %>
              <% else %>
                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                  Solo Lectura
                </span>
              <% end %>
            </div>
        </div>
      </div>
    </div>

    <!-- Resumen de gastos -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0 ml-2">
              <div class="w-8 h-8 bg-red-100 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1 ml-2">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Total Gastado</dt>
                <dd class="text-lg font-medium text-gray-900">
                  <%= number_to_currency(@project.expenses.sum(&:amount), unit: "$", separator: ",", delimiter: ".") %> COP
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0 ml-2">
              <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1 ml-2">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Saldo Restante</dt>
                <dd class="text-lg font-medium text-gray-900">
                  <%= number_to_currency(@project.quoted_value - @project.expenses.sum(&:amount), unit: "$", separator: ",", delimiter: ".") %> COP
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0 ml-2">
              <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1 ml-2">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Total Gastos</dt>
                <dd class="text-lg font-medium text-gray-900">
                  <%= @project.expenses.count %> gastos
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de usuarios con acceso al proyecto -->
    <% if @can_edit && !@project.in_liquidation? %>
      <div class="bg-white shadow rounded-lg mb-6">
        <!-- Header con t√≠tulo y bot√≥n para agregar -->
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
              <h2 class="text-lg font-medium text-gray-900">
                Usuarios con Acceso
              </h2>
              <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <%= @project.shared_projects.count %>
              </span>
            </div>
            <button type="button" onclick="toggleShareModal()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
              </svg>
              Compartir Proyecto
            </button>
          </div>
        </div>

        <!-- Lista de usuarios con acceso -->
        <div class="px-6 py-4">
          <% if @project.shared_projects.any? %>
            <div class="space-y-2">
              <% @project.shared_projects.includes(:user, :shared_by).each do |shared_project| %>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50/30 transition-all duration-200">
                  <div class="flex items-center space-x-3 flex-1">
                    <div class="flex-shrink-0">
                      <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                        <span class="text-white font-semibold text-sm"><%= shared_project.user.email[0].upcase %></span>
                      </div>
                    </div>
                    <div class="flex-1">
                      <p class="text-sm font-semibold text-gray-900"><%= shared_project.user.email %></p>
                      <div class="flex items-center space-x-2 mt-0.5">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">
                          Solo lectura
                        </span>
                        <span class="text-xs text-gray-500">
                          ‚Ä¢ <%= time_ago_in_words(shared_project.created_at) %>
                        </span>
                      </div>
                    </div>
                  </div>
                  <button onclick="if(confirm('¬øRevocar acceso a <%= shared_project.user.email %>?')) { document.getElementById('revoke-<%= shared_project.id %>').submit(); }"
                          class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium rounded-md text-red-600 bg-red-50 border border-red-200 hover:bg-red-100 hover:border-red-300 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Quitar</span>
                  </button>
                  <%= form_with url: project_shared_project_path(@project, shared_project), method: :delete, local: true, html: { id: "revoke-#{shared_project.id}", style: "display: none;" } do |f| %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Formulario para agregar gasto -->
    <% if @can_edit && !@project.in_liquidation? %>
      <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-medium text-gray-900">Agregar Nuevo Gasto</h2>
        </div>
        <div class="px-6 py-4">
          <% if @expense && @expense.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  Se encontraron <%= pluralize(@expense.errors.count, "error") %>:
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc pl-5 space-y-1">
                    <% @expense.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <%= form_with model: [@project, Expense.new], local: true, class: "space-y-4" do |f| %>
          <%= hidden_field_tag :from, 'show' %>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <%= f.label :description, "üìù Descripci√≥n", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_area :description, 
                              class: "w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-200 resize-none overflow-hidden",
                              rows: 1,
                              id: "description-textarea",
                              placeholder: "Describe el gasto realizado..." %>
            </div>
            <div>
              <%= f.label :amount, "üí∞ Valor", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :amount,
                         value: '',
                         class: "w-full border border-gray-300 rounded px-3 py-2",
                         id: "quoted_value_input",
                         autocomplete: "off" %>
            </div>
            <div>
              <%= f.label :expense_type, "üìÇ Tipo de Gasto", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.select :expense_type,
                           Expense.expense_types.map { |k, _| [t("enums.expense.expense_type.#{k}"), k] },
                           {},
                           class: "w-full border border-gray-300 rounded px-3 py-2" %>
            </div>
            <div>
              <%= f.label :expense_date, "üìÖ Fecha del Gasto", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.date_field :expense_date, 
                               value: Date.current,
                               class: "w-full border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-green-200" %>
            </div>
          </div>
          <div class="flex justify-end">
            <%= f.submit "Agregar Gasto", 
                class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",
                id: "submit-btn",
                onclick: "return validateExpenseForm();" %>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

    <!-- Lista de gastos - Acorde√≥n -->
    <div class="bg-white shadow rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <button 
          id="expenses-accordion-toggle" 
          class="flex items-center justify-between w-full text-left focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 rounded-lg p-2 -m-2"
          onclick="toggleExpensesAccordion()"
        >
          <h2 class="text-lg font-medium text-gray-900 flex items-center">
            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Gastos Registrados
            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              <%= @project.expenses.count %>
            </span>
          </h2>
          <svg 
            id="expenses-accordion-icon" 
            class="w-5 h-5 text-gray-500 transform transition-transform duration-200" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
      
      <div id="expenses-accordion-content" class="hidden overflow-hidden">
        <% if @project.expenses.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Gasto</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Liquidaci√≥n</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <% @project.expenses.each do |expense| %>
                  <tr>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 max-w-xs">
                      <div class="break-words">
                        <%= expense.description %>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <%= t("enums.expense.expense_type.#{expense.expense_type}") %>
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      <%= number_to_currency(expense.amount, unit: "$", separator: ",", delimiter: ".") %> COP
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      <%= expense.expense_date&.strftime("%d/%m/%Y") || "N/A" %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= expense.status == 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-purple-100 text-purple-800' %>">
                        <%= t("enums.expense.status.#{expense.status}") %>
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <% if @can_edit && !@project.in_liquidation? && !expense.in_liquidation? %>
                        <% if expense.persisted? %>
                          <%= link_to "Editar", edit_project_expense_path(@project, expense, from: 'show'), class: "text-blue-600 hover:text-blue-900 mr-3" %>
                          <a href="#"
                             onclick="if(confirm('¬øEst√°s seguro de eliminar este gasto?')) { document.getElementById('delete-expense-<%= expense.id %>').submit(); }"
                             class="text-red-600 hover:text-red-900">
                            Eliminar
                          </a>
                          <%= form_with url: project_expense_path(@project, expense), method: :delete, local: true, html: { id: "delete-expense-#{expense.id}", style: "display: none;" } do |f| %>
                          <% end %>
                        <% else %>
                          <span class="text-gray-400">N/A</span>
                        <% end %>
                      <% elsif expense.in_liquidation? %>
                        <span class="text-purple-600">En liquidaci√≥n</span>
                      <% else %>
                        <span class="text-gray-400">Solo lectura</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="px-6 py-8 text-center">
            <h3 class="text-sm font-medium text-gray-900">No hay gastos registrados</h3>
            <p class="mt-1 text-sm text-gray-500">Comienza agregando el primer gasto del proyecto.</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Bot√≥n de volver -->
    <div class="mt-6 flex justify-start">
      <%= link_to "‚Üê Volver a Proyectos", root_path, class: "bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" %>
    </div>
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("quoted_value_input");
        const textarea = document.getElementById("description-textarea");

        // Auto-resize textarea
        if (textarea) {
            function autoResize() {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }
            
            textarea.addEventListener('input', autoResize);
            autoResize(); // Initial resize
        }

        if (input) {
            input.addEventListener("input", function () {
                const cleanValue = input.value.replace(/\D/g, "");
                input.value = cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            });

            input.form.addEventListener("submit", function () {
                input.value = input.value.replace(/\./g, "");
            });
        }
    });

    // Funci√≥n para alternar el acorde√≥n de gastos
    function toggleExpensesAccordion() {
        const content = document.getElementById('expenses-accordion-content');
        const icon = document.getElementById('expenses-accordion-icon');
        
        if (content.classList.contains('hidden')) {
            // Abrir acorde√≥n
            content.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
        } else {
            // Cerrar acorde√≥n
            content.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
        }
    }

    // Funci√≥n para validar el formulario de gastos
    function validateExpenseForm() {
        const description = document.querySelector('textarea[name="expense[description]"]').value.trim();
        const amount = document.querySelector('input[name="expense[amount]"]').value.trim();
        const expenseType = document.querySelector('select[name="expense[expense_type]"]').value;
        const expenseDate = document.querySelector('input[name="expense[expense_date]"]').value;
        const submitBtn = document.getElementById('submit-btn');

        // Validar campos obligatorios
        if (!description) {
            alert('La descripci√≥n del gasto es obligatoria');
            return false;
        }

        if (!amount || amount === '0') {
            alert('El valor del gasto es obligatorio y debe ser mayor a 0');
            return false;
        }

        if (!expenseType) {
            alert('El tipo de gasto es obligatorio');
            return false;
        }

        if (!expenseDate) {
            alert('La fecha del gasto es obligatoria');
            return false;
        }

        // Si todo est√° bien, deshabilitar bot√≥n y mostrar efecto de carga
        setTimeout(() => {
            submitBtn.disabled = true;
            submitBtn.value = '‚è≥ Agregando...';
            submitBtn.style.opacity = '0.6';
        }, 0);

        return true;
    }

</script>

<!-- Modal para actualizar estado de ejecuci√≥n -->
<div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; overflow-y: auto;">
  <div style="position: relative; margin: 80px auto; padding: 30px; width: 500px; max-width: 90%; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);" onclick="event.stopPropagation()">
    <!-- Header del modal -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <svg style="width: 24px; height: 24px; color: #3b82f6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">Actualizar Estado de Ejecuci√≥n</h3>
      </div>
      <button type="button" onclick="closeStatusModal()" style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.color='#4b5563'; this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.color='#9ca3af'; this.style.backgroundColor='transparent';">
        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <%= form_with model: @project, url: update_status_project_path(@project), method: :patch, local: true, id: "update-status-form", data: { turbo: false } do |f| %>
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 12px;">
          Selecciona el nuevo estado del proyecto:
        </label>

        <div style="display: flex; flex-direction: column; gap: 10px;">
          <% Project.execution_statuses.each do |status_key, status_value| %>
            <% next if status_key == 'in_liquidation' %>
            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                   class="status-option"
                   onmouseover="this.style.borderColor='#3b82f6'; this.style.backgroundColor='#eff6ff';"
                   onmouseout="if(!this.querySelector('input').checked) { this.style.borderColor='#e5e7eb'; this.style.backgroundColor='transparent'; }">
              <%= f.radio_button :execution_status, status_key,
                  id: "status_#{status_key}",
                  checked: @project.execution_status == status_key,
                  style: "width: 18px; height: 18px; cursor: pointer;",
                  onchange: "updateSelectedOption(this); toggleSettlementDate(this.value);" %>
              <div style="margin-left: 12px; flex-grow: 1;">
                <span style="font-weight: 500; color: #111827; font-size: 14px;">
                  <%= t("enums.project.execution_status.#{status_key}") %>
                </span>
                <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;
                  <%= case status_key
                      when 'pending' then 'background-color: #f3f4f6; color: #1f2937;'
                      when 'running' then 'background-color: #dbeafe; color: #1e40af;'
                      when 'stop' then 'background-color: #fed7aa; color: #c2410c;'
                      when 'cancelled' then 'background-color: #fecaca; color: #991b1b;'
                      when 'ended' then 'background-color: #d1fae5; color: #065f46;'
                      end %>">
                  <% case status_key
                     when 'pending' then '‚è≥'
                     when 'running' then '‚ñ∂Ô∏è'
                     when 'stop' then '‚è∏Ô∏è'
                     when 'cancelled' then '‚ùå'
                     when 'ended' then '‚úÖ'
                     end %>
                </span>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Campo de fecha de liquidaci√≥n (solo visible cuando estado = ended) -->
      <div id="settlement_date_container" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <label for="settlement_date" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
          üìÖ Fecha de Liquidaci√≥n
        </label>
        <%= f.date_field :settlement_date,
            id: "settlement_date",
            value: @project.settlement_date || Date.current,
            style: "width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: all 0.2s; outline: none;",
            onfocus: "this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';",
            onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none';" %>
        <p style="margin-top: 6px; font-size: 12px; color: #6b7280;">
          Ingresa la fecha en que se liquid√≥ el proyecto
        </p>
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <button type="button" onclick="closeStatusModal()"
                style="padding: 10px 20px; font-size: 14px; font-weight: 500; color: #374151; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#f3f4f6';"
                onmouseout="this.style.backgroundColor='#f9fafb';">
          Cancelar
        </button>
        <%= f.submit "Actualizar Estado",
            id: "update-status-btn",
            class: "bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",
            onclick: "return validateUpdateStatusForm();" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Modal para compartir proyecto -->
<div id="shareModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; overflow-y: auto;">
  <div style="position: relative; margin: 80px auto; padding: 30px; width: 450px; max-width: 90%; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);" onclick="event.stopPropagation()">
    <!-- Header del modal -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <svg style="width: 24px; height: 24px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.645 9 12 9 12s.114.645.316 1.342m0 0a8.997 8.997 0 001.656 2.658m-1.656-2.658a8.997 8.997 0 01-1.656-2.658m0 0a8.997 8.997 0 011.656-2.658m-1.656 2.658L9 12l1.656-2.658m0 0a8.997 8.997 0 011.656 2.658m-1.656-2.658L9 12l-1.656 2.658"></path>
        </svg>
        <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">Compartir Proyecto</h3>
      </div>
      <button type="button" onclick="closeShareModal()" style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.color='#4b5563'; this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.color='#9ca3af'; this.style.backgroundColor='transparent';">
        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <%= form_with url: project_shared_projects_path(@project), method: :post, local: true do |f| %>
      <div style="margin-bottom: 24px;">
        <label for="shared_project_user_email" style="display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
          Email del usuario
          <div style="position: relative; display: inline-block;">
            <svg class="info-icon" style="width: 16px; height: 16px; color: #6b7280; cursor: help;" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div class="tooltip-text" style="visibility: hidden; opacity: 0; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); width: 250px; background-color: #1f2937; color: white; text-align: center; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: normal; z-index: 10000; transition: opacity 0.3s, visibility 0.3s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);">
              El usuario podr√° ver el proyecto y sus gastos, pero no podr√° editarlo ni eliminarlo.
              <div style="position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent;"></div>
            </div>
          </div>
        </label>
        <%= f.email_field :user_email,
            id: "shared_project_user_email",
            placeholder: "ejemplo@correo.com",
            required: true,
            style: "width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: all 0.2s; outline: none;",
            onfocus: "this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';",
            onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none';" %>
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <button type="button" onclick="closeShareModal()"
                style="padding: 10px 20px; font-size: 14px; font-weight: 500; color: #374151; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.backgroundColor='#f3f4f6';"
                onmouseout="this.style.backgroundColor='#f9fafb';">
          Cancelar
        </button>
        <%= f.submit "Compartir Proyecto",
            style: "padding: 10px 24px; font-size: 14px; font-weight: 500; color: white; background-color: #16a34a; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s;",
            onmouseover: "this.style.backgroundColor='#15803d';",
            onmouseout: "this.style.backgroundColor='#16a34a';" %>
      </div>
    <% end %>
  </div>
</div>

<style>
.info-icon:hover + .tooltip-text {
  visibility: visible !important;
  opacity: 1 !important;
}
</style>

<script>
// Funciones para el modal de estado
function toggleStatusModal() {
    const modal = document.getElementById('statusModal');
    if (!modal) {
        console.error('Status modal element not found!');
        return;
    }

    const currentDisplay = window.getComputedStyle(modal).display;
    if (currentDisplay === 'none' || modal.style.display === 'none') {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
    } else {
        modal.style.display = 'none';
    }
}

function closeStatusModal() {
    const modal = document.getElementById('statusModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function updateSelectedOption(radio) {
    // Remover el estilo de selecci√≥n de todas las opciones
    document.querySelectorAll('.status-option').forEach(option => {
        option.style.borderColor = '#e5e7eb';
        option.style.backgroundColor = 'transparent';
    });

    // Agregar el estilo de selecci√≥n a la opci√≥n seleccionada
    const selectedOption = radio.closest('.status-option');
    if (selectedOption) {
        selectedOption.style.borderColor = '#3b82f6';
        selectedOption.style.backgroundColor = '#eff6ff';
    }
}

// Mostrar/ocultar el campo de fecha de liquidaci√≥n seg√∫n el estado seleccionado
function toggleSettlementDate(status) {
    const container = document.getElementById('settlement_date_container');
    const dateInput = document.getElementById('settlement_date');

    if (status === 'ended') {
        // Mostrar el campo de fecha si el estado es "Terminado"
        container.style.display = 'block';
        dateInput.required = true;
    } else {
        // Ocultar el campo de fecha para otros estados
        container.style.display = 'none';
        dateInput.required = false;
    }
}

// Funci√≥n para validar el formulario de actualizaci√≥n de estado
function validateUpdateStatusForm() {
    const selectedStatus = document.querySelector('input[name="project[execution_status]"]:checked');
    const submitBtn = document.getElementById('update-status-btn');

    // Si el estado es "ended", validar que se haya ingresado la fecha
    if (selectedStatus && selectedStatus.value === 'ended') {
        const settlementDate = document.getElementById('settlement_date');
        if (!settlementDate.value || settlementDate.value.trim() === '') {
            alert('Por favor ingresa la fecha de liquidaci√≥n');
            return false;
        }
    }

    // Si todo est√° bien, deshabilitar bot√≥n y mostrar efecto de carga
    setTimeout(() => {
        submitBtn.disabled = true;
        submitBtn.value = '‚è≥ Actualizando...';
        submitBtn.style.opacity = '0.6';
    }, 0);

    return true;
}

// Inicializar el estado seleccionado cuando se abre el modal
document.addEventListener('DOMContentLoaded', function() {
    const statusModal = document.getElementById('statusModal');
    if (statusModal) {
        statusModal.addEventListener('click', function(event) {
            if (event.target === statusModal) {
                closeStatusModal();
            }
        });

        // Marcar la opci√≥n actualmente seleccionada al cargar
        const checkedRadio = document.querySelector('input[name="project[execution_status]"]:checked');
        if (checkedRadio) {
            updateSelectedOption(checkedRadio);
            // Mostrar el campo de fecha si el estado actual es "ended"
            toggleSettlementDate(checkedRadio.value);
        }
    }
});

// Funciones para el modal de compartir proyecto
function toggleShareModal() {
    console.log('toggleShareModal called');
    const modal = document.getElementById('shareModal');
    console.log('Modal element:', modal);

    if (!modal) {
        console.error('Modal element not found!');
        alert('Error: No se pudo encontrar el modal');
        return;
    }

    const currentDisplay = window.getComputedStyle(modal).display;
    console.log('Current display:', currentDisplay);

    if (currentDisplay === 'none' || modal.style.display === 'none') {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        console.log('Modal shown - display set to block');
    } else {
        modal.style.display = 'none';
        console.log('Modal hidden - display set to none');
    }
}

function closeShareModal() {
    console.log('closeShareModal called');
    const modal = document.getElementById('shareModal');
    if (modal) {
        modal.style.display = 'none';
        console.log('Modal closed');
    }
}

// Cerrar modal al hacer clic fuera de √©l
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - Setting up modal listeners');
    const modal = document.getElementById('shareModal');
    if (modal) {
        console.log('Modal found in DOMContentLoaded');
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeShareModal();
            }
        });
    } else {
        console.error('Modal not found in DOMContentLoaded');
    }
});
</script>
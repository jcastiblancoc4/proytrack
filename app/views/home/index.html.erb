<div class="max-w-7xl mx-auto px-3 sm:px-4 mt-4">
  <div class="mb-6">
    <!-- Header responsive -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4 gap-3">
      <div class="flex-1">
        <h1 class="text-xl sm:text-2xl font-extrabold text-blue-900 text-center sm:text-left">Proyectos Registrados</h1>
        <p class="text-xs sm:text-sm text-gray-600 mt-1 text-center sm:text-left">
          Mostrando <%= @projects.count %> de <%= @projects.count %> <%= @projects.count == 1 ? 'proyecto' : 'proyectos' %>
        </p>
      </div>

      <!-- Botones de acci√≥n en la derecha -->
      <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-start w-full sm:w-auto">
        <!-- Filtro estilo Excel -->
        <div class="relative" x-data="{ open: false }" @click.away="open = false">
          <button @click="open = !open"
                  type="button"
                  id="filter-button"
                  class="w-full sm:w-auto sm:min-w-[180px] inline-flex items-center justify-center gap-2 px-4 py-2 <%= @selected_status != 'todos' ? 'bg-blue-50 border-2 border-blue-500 text-blue-700 hover:bg-blue-100 hover:border-blue-600' : 'bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400' %> text-sm font-semibold rounded transition-all duration-200 shadow-sm">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
            <span class="flex-1 text-center">
              <% if @selected_status == 'todos' %>
                Filtrar
              <% else %>
                <%= t("enums.project.execution_status.#{@selected_status}") %>
              <% end %>
            </span>
            <!-- Badge siempre presente pero invisible cuando no hay filtro -->
            <span class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1.5 text-xs font-bold text-white rounded-full <%= @selected_status != 'todos' ? 'bg-green-600' : 'bg-transparent text-transparent' %>">
              <%= @selected_status != 'todos' ? @projects.count : '0' %>
            </span>
            <svg class="w-4 h-4 flex-shrink-0 transition-transform duration-200" :class="open ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <!-- Dropdown del filtro estilo Excel -->
          <div x-show="open"
               x-transition:enter="transition ease-out duration-100"
               x-transition:enter-start="transform opacity-0 scale-95"
               x-transition:enter-end="transform opacity-100 scale-100"
               x-transition:leave="transition ease-in duration-75"
               x-transition:leave-start="transform opacity-100 scale-100"
               x-transition:leave-end="transform opacity-0 scale-95"
               x-cloak
               @click.away="open = false"
               class="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl border border-gray-200"
               style="z-index: 9999; position: absolute !important;">

            <!-- Header del dropdown -->
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 rounded-t-lg">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                  </svg>
                  Filtrar por Estado
                </h3>
                <% if @selected_status != 'todos' %>
                  <%= link_to root_path, class: "text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors" do %>
                    Limpiar
                  <% end %>
                <% end %>
              </div>
            </div>

            <!-- Lista de opciones -->
            <div class="py-2 max-h-96 overflow-y-auto">
              <%= form_with url: root_path, method: :get, local: true do |f| %>
                <%
                  filter_options = [
                    { value: 'todos', label: 'Todos los estados', icon: 'üìã', color: 'bg-gray-100 text-gray-800' },
                    { value: 'pending', label: t('enums.project.execution_status.pending'), icon: '‚è≥', color: 'bg-gray-100 text-gray-800' },
                    { value: 'running', label: t('enums.project.execution_status.running'), icon: '‚ñ∂Ô∏è', color: 'bg-blue-100 text-blue-800' },
                    { value: 'stop', label: t('enums.project.execution_status.stop'), icon: '‚è∏Ô∏è', color: 'bg-orange-100 text-orange-800' },
                    { value: 'cancelled', label: t('enums.project.execution_status.cancelled'), icon: '‚ùå', color: 'bg-red-100 text-red-800' },
                    { value: 'ended', label: t('enums.project.execution_status.ended'), icon: '‚úÖ', color: 'bg-green-100 text-green-800' },
                    { value: 'in_liquidation', label: t('enums.project.execution_status.in_liquidation'), icon: 'üí∞', color: 'bg-purple-100 text-purple-800' }
                  ]
                %>
                <% filter_options.each do |option| %>
                  <label class="flex items-center px-4 py-2.5 hover:bg-blue-50 cursor-pointer transition-colors duration-150 group">
                    <input type="radio"
                           name="execution_status"
                           value="<%= option[:value] %>"
                           <%= 'checked' if @selected_status == option[:value] %>
                           onchange="this.form.submit();"
                           class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 focus:ring-2">
                    <div class="ml-3 flex-1 flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <span class="text-lg"><%= option[:icon] %></span>
                        <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900">
                          <%= option[:label] %>
                        </span>
                      </div>
                      <% if @selected_status == option[:value] %>
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                      <% end %>
                    </div>
                  </label>
                <% end %>
              <% end %>
            </div>

            <!-- Footer con informaci√≥n -->
            <% if @selected_status != 'todos' %>
              <div class="px-4 py-3 bg-blue-50 border-t border-blue-100 rounded-b-lg">
                <div class="flex items-center justify-between text-xs">
                  <span class="text-blue-700 font-medium">
                    <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    Filtro activo
                  </span>
                  <span class="text-blue-600 font-semibold"><%= @projects.count %> resultados</span>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <%= link_to "Nuevo Proyecto", new_project_path, class: "w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded hover:bg-blue-700 transition-colors duration-200 shadow-sm" %>
      </div>
    </div>

    <!-- Barra de b√∫squeda optimizada para m√≥vil -->
    <div class="mb-6 sm:mb-8">
      <div class="relative max-w-lg mx-auto">
        <input type="text"
               id="search-input"
               placeholder="üîç Buscar por ID o nombre..."
               class="block w-full px-3 sm:px-4 py-3 sm:py-4 text-base sm:text-lg border-2 border-gray-200 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:placeholder-gray-300 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 shadow-lg hover:shadow-xl transition-all duration-200">
      </div>
      <p class="text-center text-xs sm:text-sm text-gray-500 mt-2">Escribe para filtrar proyectos en tiempo real</p>
    </div>
  </div>

  <% if @projects.any? %>
    <% @projects.each do |project| %>
      <% amount_spent = project.expenses.pluck(:amount).sum %>
      <% quoted_less_spent = project.quoted_value.to_i - amount_spent.to_i %>
      <% color_class =
           if quoted_less_spent > 1_000_000
             "text-green-600"
           elsif quoted_less_spent >= 0
             "text-orange-500"
           else
             "text-red-600"
           end
      %>

      <!-- Tarjeta del Proyecto -->
      <div class="project-card <%= project.user == current_user ? 'bg-white' : '' %> rounded shadow-md mb-6 sm:mb-8 p-4 sm:p-6 border <%= project.user == current_user ? 'border-gray-300' : 'border-gray-300' %>"
           <%= project.user == current_user ? '' : 'style="background-color: #f0fdf4;"' %>
           data-project-name="<%= project.name.to_s.downcase %>"
           data-project-id="<%= project.project_identifier.to_s.downcase %>">
        <!-- Encabezado del Proyecto -->
        <div class="mb-4 sm:mb-6 border-b pb-3 sm:pb-4">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-xl sm:text-2xl font-extrabold text-gray-800 flex items-center gap-2">
                üìÅ <%= project.name.titleize %>
                <% if project.user != current_user %>
                  <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                    Compartido
                  </span>
                <% end %>
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">üÜî ID: <%= project.project_identifier %></p>
              <p class="text-xs sm:text-sm text-gray-500">
                <% if project.user == current_user %>
                  Registrado el <%= project.created_at.in_time_zone("Bogota").strftime("%d/%m/%Y %I:%M %p") %>
                <% else %>
                  Propietario: <%= project.user.email %>
                <% end %>
              </p>
            </div>
          </div>
        </div>

        <!-- Detalles del Proyecto -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 sm:gap-4 text-xs sm:text-sm text-gray-800 mb-4">
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600">Valor Cotizado:</strong>
            <span class="text-green-600 font-semibold"><%= number_to_currency(project.quoted_value, unit: "$", delimiter: ".", separator: ",", precision: 0) %></span>
          </div>
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600">Valor Gastado:</strong>
            <span class="text-red-600 font-semibold"><%= number_to_currency(amount_spent, unit: "$", delimiter: ".", separator: ",", precision: 0) %></span>
          </div>
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600">Diferencia:</strong>
            <span class="<%= color_class %> font-semibold"><%= number_to_currency(quoted_less_spent, unit: "$", delimiter: ".", separator: ",", precision: 0) %></span>
          </div>
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600">Orden de Compra:</strong>
            <span class="text-gray-800"><%= project.purchase_order.presence || "-" %></span>
          </div>
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600">Localidad:</strong>
            <span class="text-gray-800"><%= project.locality.presence || "-" %></span>
          </div>
          <div class="bg-gray-50 p-2 sm:p-3 rounded">
            <strong class="block text-gray-600 mb-1">Estado:</strong>
            <div class="flex items-center gap-1">
              <%
                status_styles = {
                  'pending' => 'background-color: #f3f4f6; color: #1f2937;',
                  'running' => 'background-color: #dbeafe; color: #1e3a8a;',
                  'stop' => 'background-color: #fed7aa; color: #c2410c;',
                  'cancelled' => 'background-color: #fecaca; color: #991b1b;',
                  'ended' => 'background-color: #d1fae5; color: #065f46;',
                  'in_liquidation' => 'background-color: #f3e8ff; color: #7e22ce;'
                }
                current_style = status_styles[project.execution_status] || 'background-color: #f3f4f6; color: #1f2937;'
              %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" style="<%= current_style %>">
                <%= t("enums.project.execution_status.#{project.execution_status}") %>
              </span>
              <% if project.user == current_user %>
                <button type="button" onclick="toggleStatusModal<%= project.id %>()" class="inline-flex items-center px-1.5 py-0.5 text-xs font-medium rounded text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors" title="Actualizar estado">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                  </svg>
                </button>
              <% end %>
            </div>
          </div>
        </div>


        <!-- Acciones del Proyecto -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mt-4">
          <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm">
            <%= link_to "Ver Detalles", project_path(project), class: "bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 font-medium transition-colors" %>
            <% if project.user == current_user %>
              <%= link_to "Editar", edit_project_path(project, from: 'home'), class: "bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition-colors" %>
              <a href="#" onclick="if(confirm('¬øEst√°s seguro de eliminar el registro?')) { document.getElementById('delete-project-<%= project.id %>').submit(); }" class="bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 transition-colors">Eliminar</a>
              <%= form_with url: project_path(project), method: :delete, local: true, html: { id: "delete-project-#{project.id}", style: "display: none;" } do |f| %><% end %>
            <% else %>
              <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-xs">
                Solo Lectura
              </span>
            <% end %>
          </div>
        </div>

        <!-- Modal para actualizar estado de ejecuci√≥n -->
        <% if project.user == current_user %>
          <div id="statusModal<%= project.id %>" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; overflow-y: auto;">
            <div style="position: relative; margin: 80px auto; padding: 30px; width: 500px; max-width: 90%; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);" onclick="event.stopPropagation()">
              <!-- Header del modal -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <svg style="width: 24px; height: 24px; color: #3b82f6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">Actualizar Estado de Ejecuci√≥n</h3>
                </div>
                <button type="button" onclick="closeStatusModal<%= project.id %>()" style="background: none; border: none; cursor: pointer; color: #9ca3af; padding: 4px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.color='#4b5563'; this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.color='#9ca3af'; this.style.backgroundColor='transparent';">
                  <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>

              <%= form_with model: project, url: update_status_project_path(project), method: :patch, local: true, id: "update-status-form-#{project.id}", data: { turbo: false } do |f| %>
                <div style="margin-bottom: 24px;">
                  <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 12px;">
                    Selecciona el nuevo estado del proyecto:
                  </label>

                  <div style="display: flex; flex-direction: column; gap: 10px;">
                    <% Project.execution_statuses.each do |status_key, status_value| %>
                      <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                             class="status-option-<%= project.id %>"
                             onmouseover="this.style.borderColor='#3b82f6'; this.style.backgroundColor='#eff6ff';"
                             onmouseout="if(!this.querySelector('input').checked) { this.style.borderColor='#e5e7eb'; this.style.backgroundColor='transparent'; }">
                        <%= f.radio_button :execution_status, status_key,
                            id: "status_#{status_key}_#{project.id}",
                            checked: project.execution_status == status_key,
                            style: "width: 18px; height: 18px; cursor: pointer;",
                            onchange: "updateSelectedOption#{project.id}(this); toggleSettlementDate#{project.id}(this.value);" %>
                        <div style="margin-left: 12px; flex-grow: 1;">
                          <span style="font-weight: 500; color: #111827; font-size: 14px;">
                            <%= t("enums.project.execution_status.#{status_key}") %>
                          </span>
                          <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;
                            <%= case status_key
                                when 'pending' then 'background-color: #f3f4f6; color: #1f2937;'
                                when 'running' then 'background-color: #dbeafe; color: #1e40af;'
                                when 'stop' then 'background-color: #fed7aa; color: #c2410c;'
                                when 'cancelled' then 'background-color: #fecaca; color: #991b1b;'
                                when 'ended' then 'background-color: #d1fae5; color: #065f46;'
                                when 'in_liquidation' then 'background-color: #f3e8ff; color: #7e22ce;'
                                end %>">
                            <% case status_key
                               when 'pending' then '‚è≥'
                               when 'running' then '‚ñ∂Ô∏è'
                               when 'stop' then '‚è∏Ô∏è'
                               when 'cancelled' then '‚ùå'
                               when 'ended' then '‚úÖ'
                               when 'in_liquidation' then 'üí∞'
                               end %>
                          </span>
                        </div>
                      </label>
                    <% end %>
                  </div>
                </div>

                <!-- Campo de fecha de liquidaci√≥n (solo visible cuando estado = ended) -->
                <div id="settlement_date_container_<%= project.id %>" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                  <label for="settlement_date_<%= project.id %>" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
                    üìÖ Fecha de Liquidaci√≥n
                  </label>
                  <%= f.date_field :settlement_date,
                      id: "settlement_date_#{project.id}",
                      value: project.settlement_date || Date.current,
                      style: "width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: all 0.2s; outline: none;",
                      onfocus: "this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';",
                      onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none';" %>
                  <p style="margin-top: 6px; font-size: 12px; color: #6b7280;">
                    Ingresa la fecha en que se liquid√≥ el proyecto
                  </p>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                  <button type="button" onclick="closeStatusModal<%= project.id %>()"
                          style="padding: 10px 20px; font-size: 14px; font-weight: 500; color: #374151; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                          onmouseover="this.style.backgroundColor='#f3f4f6';"
                          onmouseout="this.style.backgroundColor='#f9fafb';">
                    Cancelar
                  </button>
                  <%= f.submit "Actualizar Estado",
                      id: "update-status-btn-#{project.id}",
                      class: "bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",
                      onclick: "return validateUpdateStatusForm#{project.id}();" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>
    <% end %>
  <% else %>
    <p class="text-gray-600 mt-4 text-center">No hay proyectos registrados a√∫n.</p>
  <% end %>
</div>

<script>
    // B√∫squeda en tiempo real
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const projectCards = document.querySelectorAll('.project-card');

        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            projectCards.forEach(function(card) {
                const projectName = card.getAttribute('data-project-name');
                const projectId = card.getAttribute('data-project-id');
                
                // Buscar coincidencias en nombre o ID
                const matchesName = projectName.includes(searchTerm);
                const matchesId = projectId.includes(searchTerm);
                
                if (searchTerm === '' || matchesName || matchesId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Event listener para b√∫squeda
        searchInput.addEventListener('input', performSearch);

        // Event listener para tecla Escape
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchInput.value = '';
                performSearch();
            }
        });
    });

    // Funciones para modales de actualizaci√≥n de estado (din√°micas por proyecto)
    <% @projects.each do |project| %>
      <% if project.user == current_user %>
        function toggleStatusModal<%= project.id %>() {
            const modal = document.getElementById('statusModal<%= project.id %>');
            if (!modal) return;

            const currentDisplay = window.getComputedStyle(modal).display;
            if (currentDisplay === 'none' || modal.style.display === 'none') {
                modal.style.display = 'block';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';

                // Inicializar el estado seleccionado
                const checkedRadio = document.querySelector('input[name="project[execution_status]"][id*="_<%= project.id %>"]:checked');
                if (checkedRadio) {
                    updateSelectedOption<%= project.id %>(checkedRadio);
                    toggleSettlementDate<%= project.id %>(checkedRadio.value);
                }
            } else {
                modal.style.display = 'none';
            }
        }

        function closeStatusModal<%= project.id %>() {
            const modal = document.getElementById('statusModal<%= project.id %>');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateSelectedOption<%= project.id %>(radio) {
            document.querySelectorAll('.status-option-<%= project.id %>').forEach(option => {
                option.style.borderColor = '#e5e7eb';
                option.style.backgroundColor = 'transparent';
            });

            const selectedOption = radio.closest('.status-option-<%= project.id %>');
            if (selectedOption) {
                selectedOption.style.borderColor = '#3b82f6';
                selectedOption.style.backgroundColor = '#eff6ff';
            }
        }

        function toggleSettlementDate<%= project.id %>(status) {
            const container = document.getElementById('settlement_date_container_<%= project.id %>');
            const dateInput = document.getElementById('settlement_date_<%= project.id %>');

            if (status === 'ended') {
                container.style.display = 'block';
                dateInput.required = true;
            } else {
                container.style.display = 'none';
                dateInput.required = false;
            }
        }

        function validateUpdateStatusForm<%= project.id %>() {
            const selectedStatus = document.querySelector('input[name="project[execution_status]"][id*="_<%= project.id %>"]:checked');
            const submitBtn = document.getElementById('update-status-btn-<%= project.id %>');

            if (selectedStatus && selectedStatus.value === 'ended') {
                const settlementDate = document.getElementById('settlement_date_<%= project.id %>');
                if (!settlementDate.value || settlementDate.value.trim() === '') {
                    alert('Por favor ingresa la fecha de liquidaci√≥n');
                    return false;
                }
            }

            setTimeout(() => {
                submitBtn.disabled = true;
                submitBtn.value = '‚è≥ Actualizando...';
                submitBtn.style.opacity = '0.6';
            }, 0);

            return true;
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('statusModal<%= project.id %>');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeStatusModal<%= project.id %>();
                    }
                });
            }
        });
      <% end %>
    <% end %>
</script>

<style>
  /* Asegurar que Alpine.js x-cloak oculte elementos correctamente */
  [x-cloak] {
    display: none !important;
  }
</style>
